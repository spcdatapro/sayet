<div class="container" ng-controller="otSimplificadoCtrl">
    <ul class="nav nav-tabs">
        <li class="active">
            <a show-tab href="#divPresupuestos" data-toggle="tab">&Oacute;RDEN DE TRABAJO</a>
        </li>
        <li ng-show="+presupuesto.id > 0">
            <a show-tab href="#divDocumentos" data-toggle="tab">DOCUMENTOS</a>
        </li>
        <!--
        <li ng-show="+presupuesto.id > 0">
            <a show-tab href="#divDetPresup" data-toggle="tab">DETALLE</a>
        </li>
        -->
    </ul>

    <div class="tab-content">
        <div id="divPresupuestos" class="tab-pane fade in active">
            <div class="panel panel-info" style="padding-left: 5px; padding-right: 5px;">
                <div class="panel-heading">&oacute;rden de trabajo {{presupuesto.id ? ('#' + presupuesto.id) : ''}}
                </div>
                <div class="panel-body">
                    <div class="row">
                        <div class="col-md-6" style="border-right: dashed 1px lightgray;">
                            <div class="row">
                                <div class="col-md-12">
                                    <strong>OTS</strong>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <form name="frmPresup" id="frmPresup"
                                        ng-submit="frmPresup.$valid && addPresupuesto(presupuesto)" novalidate>
                                        <div class="row">
                                            <div class="col-md-6 nopadding">
                                                <div class="form-group"
                                                    ng-class="{'has-error':frmPresup.selTipo.$invalid && !frmPresup.selTipo.$pristine}">
                                                    <label for="selTipo">Tipo:</label>
                                                    <select name="selTipo" id="selTipo" class="form-control"
                                                        ng-model="presupuesto.tipo" ng-disabled="sl.presupuesto"
                                                        required>
                                                        <option value="1" selected>Simple</option>
                                                        <option value="2">M&uacute;ltiple</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-md-6 nopadding">
                                                <div class="form-group"
                                                    ng-class="{'has-error':frmPresup.txtFecSol.$invalid && !frmPresup.txtFecSol.$pristine}">
                                                    <label for="txtFecSol">Fecha de solicitud:</label>
                                                    <input name="txtFecSol" id="txtFecSol" type="date"
                                                        class="form-control" ng-model="presupuesto.fechasolicitud"
                                                        required ng-disabled="sl.presupuesto" />
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-12 nopadding">
                                                <div class="form-group"
                                                    ng-class="{'has-error':frmPresup.selProy.$invalid && !frmPresup.selProy.$pristine}">
                                                    <label>Proyecto:</label>
                                                    <ui-select ng-model="presupuesto.proyecto"
                                                        title="Seleccione un proyecto..." theme="bootstrap"
                                                        autofocus="true" append-to-body="true"
                                                        on-select="setEmpresa($item)" ng-disabled="sl.presupuesto">
                                                        <ui-select-match placeholder="Buscar proyecto..."
                                                            allow-clear="false">
                                                            <span ng-bind="$select.selected.nomproyecto"></span>
                                                        </ui-select-match>
                                                        <ui-select-choices
                                                            repeat="item.id as item in proyectos | filter:$select.search">
                                                            <div
                                                                ng-bind-html="item.nomproyecto | highlight: $select.search">
                                                            </div>
                                                            <small>
                                                                <strong>Empresa:</strong>&nbsp;<span
                                                                    ng-bind-html="item.empresa | highlight: $select.search"></span><br />
                                                                <strong>Tipo:</strong>&nbsp;<span
                                                                    ng-bind-html="item.tipoproyecto | highlight: $select.search"></span>
                                                            </small>
                                                        </ui-select-choices>
                                                        <ui-select-no-choice>
                                                            No hay resultados...
                                                        </ui-select-no-choice>
                                                    </ui-select>
                                                </div>
                                            </div>
                                            <div class="col-md-12 nopadding">
                                                <div class="form-group"
                                                    ng-class="{'has-error':frmPresup.selEmp.$invalid && !frmPresup.selEmp.$pristine}">
                                                    <label>Empresa:</label>
                                                    <ui-select ng-model="presupuesto.empresa"
                                                        title="Seleccione una empresa..." theme="bootstrap"
                                                        autofocus="true" append-to-body="true"
                                                        ng-disabled="sl.presupuesto">
                                                        <ui-select-match placeholder="Buscar empresa..."
                                                            allow-clear="false">
                                                            <span ng-bind="$select.selected.nomempresa"></span>
                                                        </ui-select-match>
                                                        <ui-select-choices
                                                            repeat="item.id as item in empresas | filter:$select.search">
                                                            <div
                                                                ng-bind-html="item.nomempresa | highlight: $select.search">
                                                            </div>
                                                        </ui-select-choices>
                                                        <ui-select-no-choice>
                                                            No hay resultados...
                                                        </ui-select-no-choice>
                                                    </ui-select>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6 nopadding">
                                                <div class="form-group"
                                                    ng-class="{'has-error':frmPresup.selTipoGasto.$invalid && !frmPresup.selTipoGasto.$pristine}">
                                                    <label for="selTipoGasto">Tipo de gasto:</label>
                                                    <select name="selTipoGasto" id="selTipoGasto" class="form-control"
                                                        ng-model="presupuesto.idtipogasto"
                                                        ng-options="obj.id as obj.desctipogast for obj in tiposgasto"
                                                        required ng-disabled="sl.presupuesto"
                                                        ng-change="loadSubtTiposGasto(presupuesto.idtipogasto)">
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-md-3 nopadding">
                                                <div class="form-group"
                                                    ng-class="{'has-error':frmPresup.selMoneda.$invalid && !frmPresup.selMoneda.$pristine}">
                                                    <label for="selMoneda">Moneda:</label>
                                                    <select name="selMoneda" id="selMoneda" class="form-control"
                                                        ng-model="presupuesto.idmoneda"
                                                        ng-options="obj.id as obj.simbolo for obj in monedas" required
                                                        ng-disabled="sl.presupuesto">
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-md-3 nopadding">
                                                <div class="form-group"
                                                    ng-class="{'has-error':frmPresup.txtTotal.$invalid && !frmPresup.txtTotal.$pristine}">
                                                    <label for="txtTotal">Total:</label>
                                                    <input name="txtTotal" id="txtTotal" class="form-control"
                                                        type="text" ng-model="presupuesto.total"
                                                        fcsa-number="{maxDecimals:2}" ng-disabled="true" />
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row" ng-show="+presupuesto.tipo == 1">
                                            <div class="col-md-12 nopadding">
                                                <div class="form-group"
                                                    ng-class="{'has-error':frmPresup.selProveedorPresup.$invalid && !frmOT.selProveedorPresup.$pristine}">
                                                    <label>Proveedor/Beneficiario:</label>
                                                    <ui-select name="selProveedorPresup"
                                                        ng-model="presupuesto.idproveedor"
                                                        title="Seleccione un proveedor/beneficiario..."
                                                        theme="bootstrap" autofocus="true" append-to-body="true"
                                                        ng-required="+presupuesto.tipo == 1"
                                                        ng-disabled="sl.presupuesto" on-select="setOrigenProv($item)">
                                                        <ui-select-match placeholder="Buscar proveedor/beneficiario..."
                                                            allow-clear="false">
                                                            <span ng-bind="$select.selected.beneficiario"></span>
                                                        </ui-select-match>
                                                        <ui-select-choices
                                                            repeat="item.id as item in proveedores | filter:$select.search"
                                                            group-by="'grupo'">
                                                            <div
                                                                ng-bind-html="item.beneficiario | highlight: $select.search">
                                                            </div>
                                                            <small>
                                                                <strong>N.I.T.:</strong>&nbsp;<span
                                                                    ng-bind-html="item.nit | highlight: $select.search"></span>
                                                            </small>
                                                        </ui-select-choices <ui-select-no-choice>
                                                        No hay resultados...
                                                        </ui-select-no-choice>
                                                    </ui-select>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row" ng-show="+presupuesto.tipo == 1">
                                            <div class="col-md-12 nopadding">
                                                <div class="form-group"
                                                    ng-class="{'has-error':frmPresup.selSubtTipoGastoPresup.$invalid && !frmPresup.selSubtTipoGastoPresup.$pristine}">
                                                    <label>Sub-tipo de gasto:</label>
                                                    <ui-select name="selSubtTipoGastoPresup"
                                                        ng-model="presupuesto.idsubtipogasto"
                                                        title="Seleccione un sub-tipo de gasto..." theme="bootstrap"
                                                        autofocus="false" append-to-body="true"
                                                        ng-required="+presupuesto.tipo == 1"
                                                        ng-disabled="sl.presupuesto">
                                                        <ui-select-match placeholder="Buscar sub-tipo de gasto..."
                                                            allow-clear="false">
                                                            <span ng-bind="$select.selected.descripcion"></span>
                                                        </ui-select-match>
                                                        <ui-select-choices
                                                            repeat="item.id as item in subtiposgasto | filter:$select.search">
                                                            <div
                                                                ng-bind-html="item.descripcion | highlight: $select.search">
                                                            </div>
                                                        </ui-select-choices>
                                                        <ui-select-no-choice>
                                                            No hay resultados...
                                                        </ui-select-no-choice>
                                                    </ui-select>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row" ng-show="+presupuesto.tipo == 1">
                                            <div class="col-md-4 nopadding">
                                                <div class="form-group">
                                                    <label for="chkIVAPresup">I.V.A.</label>
                                                    <input name="chkIVAPresup" id="chkIVAPresup" type="checkbox"
                                                        class="form-control" ng-model="presupuesto.coniva"
                                                        ng-true-value="1" ng-false-value="0"
                                                        ng-disabled="sl.presupuesto" />
                                                </div>
                                            </div>
                                            <div class="col-md-4 nopadding">
                                                <div class="form-group"
                                                    ng-class="{'has-error':frmPresup.txtMontoPresup.$invalid && !frmPresup.txtMontoPresup.$pristine}">
                                                    <label for="txtMontoPresup">Valor:</label>
                                                    <input name="txtMontoPresup" id="txtMontoPresup" type="text"
                                                        class="form-control" ng-model="presupuesto.monto"
                                                        fcsa-number="{maxDecimals:2}"
                                                        ng-required="+presupuesto.tipo == 1"
                                                        ng-disabled="sl.presupuesto" />
                                                </div>
                                            </div>
                                            <div class="col-md-4 nopadding">
                                                <div class="form-group"
                                                    ng-class="{'has-error':frmPresup.txtTCPresup.$invalid && !frmPresup.txtTCPresup.$pristine}">
                                                    <label for="txtTCPresup">TC:</label>
                                                    <input name="txtTCPresup" id="txtTCPresup" type="text"
                                                        class="form-control" ng-model="presupuesto.tipocambio"
                                                        fcsa-number="{maxDecimals:4}"
                                                        ng-required="+presupuesto.tipo == 1"
                                                        ng-disabled="sl.presupuesto" />
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-12 nopadding">
                                                <div class="form-group"
                                                    ng-class="{'has-error':frmPresup.selTipoDocumento.$invalid && !frmPresup.selTipoDocumento.$pristine}">
                                                    <label for="selTipoDocumento">Tipo de documento:</label>
                                                    <select name="selTipoDocumento" id="selTipoDocumento"
                                                        class="form-control" ng-model="presupuesto.tipodocumento"
                                                        ng-disabled="sl.presupuesto" required>
                                                        <option value="1" selected>Factura</option>
                                                        <option value="2">Reembolso</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-12 nopadding">
                                                <div class="form-group">
                                                    <label for="txtDescrip">Descripci&oacute;n:</label>
                                                    <textarea name="txtDescrip" id="txtDescrip" class="form-control"
                                                        style="width:100%" ng-model="presupuesto.notas" rows="3"
                                                        ng-disabled="sl.presupuesto">
                                                </textarea>
                                                </div>
                                            </div>
                                        </div>
                                        <form-buttons vis="grpBtnPresupuesto" btn-dis="frmPresup.$invalid"
                                            obj="presupuesto" uf="updPresupuesto(presupuesto)"
                                            df="delPresupuesto(presupuesto)" nf="nuevoPresupuesto()"
                                            cf="cancelEditPresup()" ef="startEditPresup()" pf="imprimirPresup()"
                                            ng-hide="(+presupuesto.idestatuspresupuesto == 6 || +presupuesto.idestatuspresupuesto == 5) || !permiso.m">
                                        </form-buttons>
                                        <button type="button" class="btn btn-info"
                                            ng-click="verDetPagos(presupuesto, true)"
                                            ng-show="+presupuesto.idestatuspresupuesto == 3 && permiso.m && +presupuesto.tipo == 1"
                                            data-toggle="tooltip" data-placement="auto" title="Ver detalle de pagos...">
                                            <i class="fa fa-money fa-lg" aria-hidden="true"></i>
                                        </button>
                                        <button type="button" class="btn btn-info"
                                            ng-click="printOt(presupuesto.id, true)"
                                            ng-show="+presupuesto.idestatuspresupuesto == 3 && permiso.m && +presupuesto.tipo == 1"
                                            data-toggle="tooltip" data-placement="auto" title="Imprimir...">
                                            <i class="fa fa-print fa-lg" aria-hidden="true"></i>
                                        </button>
                                        <button type="button" class="btn btn-primary"
                                            ng-click="aumentaExcedente(presupuesto)"
                                            ng-show="+presupuesto.idestatuspresupuesto == 3 && permiso.m && +presupuesto.tipo == 1"
                                            data-toggle="tooltip" data-placement="auto"
                                            title="Cambiar porcentaje de excedente...">
                                            <span class="glyphicon glyphicon-arrow-up"></span>
                                        </button>
                                        <button type="button" class="btn btn-warning"
                                            ng-click="terminaPresupuesto(presupuesto)"
                                            ng-show="+presupuesto.idestatuspresupuesto == 3 && permiso.m"
                                            data-toggle="tooltip" data-placement="auto" title="Terminar presupuesto">
                                            <span class="glyphicon glyphicon-folder-close"></span>
                                        </button>
                                        <button type="button" class="btn btn-warning"
                                            ng-click="reabrirPresupuesto(presupuesto)"
                                            ng-show="+presupuesto.idestatuspresupuesto == 5 && permiso.m"
                                            data-toggle="tooltip" data-placement="auto" title="Re-abrir presupuesto">
                                            <span class="glyphicon glyphicon-folder-open"></span>
                                        </button>
                                        <button type="button" class="btn btn-danger"
                                            ng-click="anulaPresupuesto(presupuesto)"
                                            ng-show="+presupuesto.id > 0 && +presupuesto.idestatuspresupuesto < 4 && permiso.m"
                                            data-toggle="tooltip" data-placement="auto" title="Anular">
                                            <span class="glyphicon glyphicon-remove-circle"></span>
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="row" ng-show="+ot.id > 0">
                                <div class="col-md-12">
                                    <strong>Formas de pago</strong>
                                </div>
                            </div>
                            <div class="row" ng-show="+ot.id > 0">
                                <div class="col-md-12">
                                    <form name="frmDetPago" id="frmDetPago"
                                        ng-submit="frmDetPago.$valid && addFormaPago(fpago)" novalidate>
                                        <div class="row">
                                            <div class="col-md-3 nopadding">
                                                <div class="form-group">
                                                    <label for="selMonedaFP">Moneda:</label>
                                                    <select name="selMonedaFP" id="selMonedaFP" class="form-control"
                                                        ng-model="fpago.idmoneda"
                                                        ng-options="obj.id as obj.simbolo for obj in monedas" required>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-md-3 nopadding">
                                                <div class="form-group">
                                                    <label for="txtMontoDetP">Monto:</label>
                                                    <input name="txtMontoDetP" id="txtMontoDetP" type="number"
                                                        class="form-control" ng-model="fpago.monto" step="0.01"
                                                        min="0.01" ng-blur="calcPorcentaje()" required />
                                                </div>
                                            </div>
                                            <div class="col-md-3 nopadding">
                                                <div class="form-group">
                                                    <label for="chkQuitarISR">Quitar I.S.R.:</label>
                                                    <input name="chkQuitarISR" id="chkQuitarISR" type="checkbox"
                                                        class="form-control" ng-model="fpago.quitarisr"
                                                        ng-true-value="1" ng-false-value="0" />
                                                </div>
                                            </div>
                                            <div class="col-md-3 nopadding">
                                                <div class="form-group">
                                                    <label for="txtMontoDetISR">Monto calc. I.S.R.:</label>
                                                    <input name="txtMontoDetISR" id="txtMontoDetISR" type="number"
                                                        class="form-control" ng-model="fpago.isr" min="0.00" step="0.01"
                                                        ng-disabled="+fpago.quitarisr == 0"
                                                        ng-required="+fpago.quitarisr == 1" />
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-12 nopadding">
                                                <div class="form-group">
                                                    <label for="txtNotas">Notas:</label>
                                                    <textarea name="txtNotas" id="txtNotas" class="form-control"
                                                        rows="1" maxlength="1000" ng-model="fpago.notas"
                                                        placeholder="Notas para el pago..."
                                                        style="width: 100%"></textarea>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="btn-group" role="group" aria-label="...">
                                            <button type="submit" class="btn btn-info" ng-disabled="frmDetPago.$invalid"
                                                ng-show="sumporcentaje < porexcede && [5, 6].indexOf(+ot.idestatuspresupuesto) < 0 && permiso.m"
                                                ng-hide="+fpago.id > 0">
                                                <span class="glyphicon glyphicon-floppy-save"></span>
                                            </button>
                                            <button type="button" class="btn btn-info" ng-click="updFormaPago(fpago)"
                                                ng-disabled="frmDetPago.$invalid"
                                                ng-show="+fpago.id > 0 && [5, 6].indexOf(+ot.idestatuspresupuesto) < 0 && permiso.m">
                                                <span class="glyphicon glyphicon-floppy-save"></span>
                                            </button>
                                        </div>
                                    </form>
                                    <hr />
                                    <table class="table table-hover table-condensed">
                                        <thead>
                                            <tr>
                                                <th style="text-align: right">No.</th>
                                                <!--<th style="text-align: right">%</th>-->
                                                <th style="text-align: right">Monto</th>
                                                <th style="text-align: right">Quitar I.S.R.</th>
                                                <th>&nbsp;</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr ng-repeat="det in lstdetpagos" ng-click="getFormaPago(det)">
                                                <td style="text-align: right">{{det.nopago}}</td>
                                                <!--<td style="text-align: right">{{det.porcentaje | number:4}}</td>-->
                                                <td style="text-align: right">{{det.moneda}} {{det.monto | number:2}}
                                                </td>
                                                <td style="text-align: right">{{+det.quitarisr == 0 ? 'No' : 'Sí'}}</td>
                                                <td>
                                                    <button type="button" class="btn btn-danger btn-sm"
                                                        ng-click="delFormaPago(det)"
                                                        ng-show="permiso.e && [5, 6].indexOf(+ot.idestatuspresupuesto) < 0">
                                                        <span class="glyphicon glyphicon-trash"></span>
                                                    </button>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <hr />
                    <table class="table table-condensed">
                        <caption>
                            <form name="frmBusqueda" class="form-inline">
                                <label for="srchTxtDel">Del:</label>
                                <input name="srchTxtDel" id="srchTxtDel" type="date" class="form-control input-sm"
                                    ng-model="params.fdel" required />
                                <label for="srchTxtAl">al:</label>
                                <div class="input-group">
                                    <input name="srchTxtAl" id="srchTxtAl" type="date" class="form-control input-sm"
                                        ng-model="params.fal" required />
                                    <span class="input-group-btn">
                                        <button type="button" class="btn btn-primary btn-sm" ng-click="loadOts()"
                                            ng-disabled="frmBusqueda.$invalid"><i class="fa fa-search"
                                                aria-hidden="true"></i></button>
                                    </span>
                                </div>
                                <input type="text" class="form-control input-sm" style="width: 40%;"
                                    ng-model="buscador.$" placeholder="Buscar..." /><br />
                                <div class="btn-group" role="group" aria-label="..."
                                    style="padding-top: 0.75em; width: 100%; margin: 0 auto !important;">
                                    <button type="button" class="btn btn-default btn-sm tipo"
                                        ng-click="loadOts('1,2,3')">
                                        En proceso
                                    </button>
                                    <button type="button" class="btn btn-default btn-sm tipo" ng-click="loadOts('4,5')">
                                        Terminados
                                    </button>
                                    <button type="button" class="btn btn-default btn-sm tipo" ng-click="loadOts('6')">
                                        Anulados
                                    </button>
                                    <button type="button" class="btn btn-default btn-sm tipo" ng-click="loadOts(null)">
                                        Todos
                                    </button>
                                </div>
                            </form>
                        </caption>
                        <thead>
                            <tr>
                                <th style="text-align: left">No.</th>
                                <th>Solicitud</th>
                                <th>Proyecto</th>
                                <th>Empresa</th>
                                <th>Tipo</th>
                                <th>Prov./Bene.</th>
                                <th style="text-align: right">Total</th>
                                <!--
                                <th style="text-align: right">Gastado</th>
                                <th>&nbsp;</th>
                                -->
                            </tr>
                        </thead>
                        <tbody>
                            <tr ng-repeat="p in lstots | filter:buscador" ng-click="getPresupuesto(p.id)"
                                ng-class="{'bld': +p.tipo!= 1, 'presPendiente': +p.idestatuspresupuesto == 2 && +p.tipo == 1, 'presAprobado': +p.idestatuspresupuesto == 3 && +p.tipo == 1}">
                                <td style="white-space: nowrap">{{p.tipostr}}-{{p.id}}</td>
                                <td>{{p.fechasolicitud | date:'dd/MM/yyyy'}}</td>
                                <td>{{p.proyecto | shortenStr:17}}</td>
                                <td>{{p.abreviaempre}}</td>
                                <td>{{p.tipogasto | shortenStr:10}}</td>
                                <td>
                                    <p style="white-space: normal">{{p.proveedor | shortenStr:22}}</p>
                                </td>
                                <td style="text-align: right; width: 10% !important;">
                                    {{p.simbolo}}&nbsp;{{p.total | number:2}}</td>
                                <!--
                            <td style="text-align: right; width: 10% !important;">
                                {{p.gastado ? ('Q ' + (p.gastado | number:2)) : ''}}</td>
                            <td style="white-space: nowrap !important;">
                                <div class="btn-group" role="group" aria-label="..."
                                    style="white-space: nowrap !important;">
                                    <button type="button" class="btn btn-info btn-sm tipo"
                                        ng-click="printPrespuesto(p.id, 0)" data-toggle="tooltip"
                                        data-placement="auto" title="Imprimir sin avances">
                                        R.
                                    </button>
                                    <button type="button" class="btn btn-default btn-sm tipo"
                                        ng-click="printPrespuesto(p.id, 1)" data-toggle="tooltip"
                                        data-placement="auto" title="Imprimir con avances">
                                        D.
                                    </button>
                                    <button type="button" class="btn btn-primary btn-sm tipo"
                                        ng-click="printOt(p.idot)" data-toggle="tooltip" data-placement="auto"
                                        title="Imprimir detalle" ng-show="+p.tipo === 1">
                                        <span class="glyphicon glyphicon-print"></span>
                                    </button>
                                    <button type="button" class="btn btn-info btn-sm tipo" ng-click="enviar(p)"
                                        ng-show="+p.idestatuspresupuesto == 1 && +p.tipo == 1" data-toggle="tooltip"
                                        data-placement="auto" title="Enviar presupuesto a aprobación...">
                                        <span class="glyphicon glyphicon-share-alt"></span>
                                    </button>
                                    <button type="button" class="btn btn-warning btn-sm tipo"
                                        ng-click="terminaPresupuesto(p)"
                                        ng-show="+p.idestatuspresupuesto == 3 && permiso.m && +p.tipo == 1"
                                        data-toggle="tooltip" data-placement="auto" title="Terminar presupuesto">
                                        <span class="glyphicon glyphicon-folder-close"></span>
                                    </button>
                                    <button type="button" class="btn btn-warning btn-sm tipo"
                                        ng-click="reabrirPresupuesto(p)"
                                        ng-show="+p.idestatuspresupuesto == 5 && permiso.m && +p.tipo == 1"
                                        data-toggle="tooltip" data-placement="auto" title="Re-abrir presupuesto">
                                        <span class="glyphicon glyphicon-folder-open"></span>
                                    </button>
                                    <button type="button" class="btn btn-danger btn-sm tipo"
                                        ng-click="anulaPresupuesto(p)"
                                        ng-show="+p.idestatuspresupuesto < 4 && permiso.m && +p.tipo == 1"
                                        data-toggle="tooltip" data-placement="auto" title="Anular">
                                        <span class="glyphicon glyphicon-remove-circle"></span>
                                    </button>
                                </div>
                            </td>
                            -->
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div id="divDocumentos" class="tab-pane fade">
            <div class="panel panel-info">
                <div class="panel-heading">Documentos</div>
                <div class="panel-body">
                    <div id="divFacturaCompra" class="row" ng-show="+presupuesto.tipodocumento == 1">
                        <form name="frmCompra" id="frmCompra" ng-submit="frmCompra.$valid && addCompra(laCompra)" novalidate>
                            <div class="row">
                                <div class="col-md-5">
                                    <div class="form-group required"
                                        ng-class="{'has-error':frmCompra.selProv.$invalid && !frmCompra.selProv.$pristine}">
                                        <label class="control-label">Proveedor:</label>
                                        <ui-select ng-model="laCompra.objProveedor" title="Seleccione un proveedor..."
                                            theme="bootstrap" autofocus="true" ng-required="true"
                                            on-select="getConcepto($item)">
                                            <ui-select-match placeholder="Buscar proveedor..." allow-clear="false">
                                                <span ng-bind="$select.selected.nombre"></span>
                                            </ui-select-match>
                                            <ui-select-choices refresh="fetch($select)"
                                                repeat="item in losProvs | filter:$select.search | limitTo:itemsLimit"
                                                scroll-detector="loadDataProvs()">
                                                <div ng-bind-html="item.nombre | highlight: $select.search"></div>
                                                <small>
                                                    <strong>N.I.T.:</strong>&nbsp;<span
                                                        ng-bind-html="item.nit | highlight: $select.search"></span>
                                                </small>
                                            </ui-select-choices>
                                            <ui-select-no-choice>No hay resultados...</ui-select-no-choice>
                                        </ui-select>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group required"
                                        ng-class="{'has-error':frmCompra.selTipoFact.$invalid && !frmCompra.selTipoFact.$pristine}">
                                        <label class="control-label">Tipo:</label>
                                        <ui-select ng-model="laCompra.objTipoFactura"
                                            title="Seleccione un tipo de factura..." theme="bootstrap" autofocus="false"
                                            ng-required="true" on-select="calcular()">
                                            <ui-select-match placeholder="Buscar..." allow-clear="false">
                                                <span ng-bind="$select.selected.siglas"></span>
                                            </ui-select-match>
                                            <ui-select-choices
                                                repeat="item in lsttiposfact | filter:{desctipofact: $select.search, siglas: $select.search, paracompra: 1}">
                                                <div ng-bind-html="item.siglas | highlight: $select.search"></div>
                                                <small>
                                                    <span
                                                        ng-bind-html="item.desctipofact | highlight: $select.search"></span>
                                                </small>
                                            </ui-select-choices>
                                            <ui-select-no-choice>No hay resultados...</ui-select-no-choice>
                                        </ui-select>

                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group required"
                                        ng-class="{'has-error':frmCompra.txtSerie.$invalid && !frmCompra.txtSerie.$pristine}">
                                        <label for="txtSerie" class="control-label">Serie:</label>
                                        <input name="txtSerie" id="txtSerie" type="text" class="form-control"
                                            ng-model="laCompra.serie" placeholder="Serie" maxlength="15"
                                            ng-change="chkExisteCompra()" required />
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group required"
                                        ng-class="{'has-error':frmCompra.txtDocu.$invalid && !frmCompra.txtDocu.$pristine}">
                                        <label for="txtDocu" class="control-label">Documento:</label>
                                        <input name="txtDocu" id="txtDocu" type="text" class="form-control"
                                            ng-model="laCompra.documento" ng-change="chkExisteCompra()"
                                            placeholder="Documento" required />
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="form-group required"
                                        ng-class="{'has-error':frmCompra.txtFechaIng.$invalid && !frmCompra.txtFechaIng.$pristine}">
                                        <label for="txtFechaIng" class="control-label">Fecha de ingreso:</label>
                                        <input name="txtFechaIng" id="txtFechaIng" type="date" class="form-control"
                                            ng-model="laCompra.fechaingreso"
                                            ng-change="chkFecha(laCompra.fechaingreso, 1); setMesIva(laCompra.fechaingreso); chkFechaEnPeriodo(laCompra.fechaingreso);"
                                            required />
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group required"
                                        ng-class="{'has-error':frmCompra.txtMesIva.$invalid && !frmCompra.txtMesIva.$pristine}">
                                        <label for="txtMesIva" class="control-label">Mes I.V.A.:</label>
                                        <input name="txtMesIva" id="txtMesIva" type="number" class="form-control"
                                            ng-model="laCompra.mesiva" min="1" max="12" required ng-disabled="true" />
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group required"
                                        ng-class="{'has-error':frmCompra.txtFechaFact.$invalid && !frmCompra.txtFechaFact.$pristine}">
                                        <label for="txtFechaFact" class="control-label">Fecha de factura:</label>
                                        <input name="txtFechaFact" id="txtFechaFact" type="date" class="form-control"
                                            ng-model="laCompra.fechafactura" required />
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group required"
                                        ng-class="{'has-error':frmCompra.selTipoCompra.$invalid && !frmCompra.selTipoCompra.$pristine}">
                                        <label for="selTipoCompra" class="control-label">Tipo de compra:</label>
                                        <select name="selTipoCompra" id="selTipoCompra" class="form-control"
                                            ng-model="laCompra.objTipoCompra"
                                            ng-options="obj.desctipocompra for obj in losTiposCompra track by obj.id"
                                            ng-change="calcular()" required>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <!-- Cuando el tipo de compra es combustible -->
                            <div class="row" ng-show="laCompra.objTipoCompra.id == 3">
                                <div class="col-md-4">
                                    <div class="form-group required"
                                        ng-class="{'has-error':frmCompra.selTipoComb.$invalid && !frmCompra.selTipoComb.$pristine}">
                                        <label for="selTipoComb" class="control-label">Tipo de combustible:</label>
                                        <select name="selTipoComb" id="selTipoComb" class="form-control"
                                            ng-model="laCompra.objTipoCombustible"
                                            ng-options="obj.descripcion for obj in combustibles track by obj.id"
                                            ng-change="calcular()">
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group required"
                                        ng-class="{'has-error':frmCompra.txtGalones.$invalid && !frmCompra.txtGalones.$pristine}">
                                        <label for="txtGalones" class="control-label">Galones:</label>
                                        <input name="txtGalones" id="txtGalones" type="text" class="form-control"
                                            ng-model="laCompra.galones" fcsa-number="{min:0, maxDecimals:2}"
                                            ng-change="calcular()" />
                                    </div>
                                </div>
                            </div>
                            <!-- Fin de cuando el tipo de compra es combustible -->
                            <div class="row">
                                <div class="col-md-5">
                                    <div class="form-group required"
                                        ng-class="{'has-error':frmCompra.selProy.$invalid && !frmCompra.selProy.$pristine}">
                                        <label class="control-label">Proyecto:</label>
                                        <ui-select ng-model="laCompra.idproyecto" title="Seleccione un proyecto..."
                                            theme="bootstrap" autofocus="false" ng-required="true"
                                            on-select="proyectoSelected($item)" ng-disabled="true">
                                            <ui-select-match placeholder="Buscar proyecto..." allow-clear="false">
                                                <span ng-bind="$select.selected.nomproyecto"></span>
                                            </ui-select-match>
                                            <ui-select-choices
                                                repeat="item.id as item in proyectos | filter:$select.search">
                                                <div ng-bind-html="item.nomproyecto | highlight: $select.search"></div>
                                                <small>
                                                    <strong>Referencia:</strong>&nbsp;<span
                                                        ng-bind-html="item.referencia | highlight: $select.search"></span>
                                                </small>
                                            </ui-select-choices>
                                            <ui-select-no-choice>No hay resultados...</ui-select-no-choice>
                                        </ui-select>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group"
                                        ng-class="{'has-error':frmCompra.selUnidad.$invalid && !frmCompra.selUnidad.$pristine}">
                                        <label for="selUnidad" class="control-label">Unidad (si aplica):</label>
                                        <select name="selUnidad" id="selUnidad" class="form-control"
                                            ng-model="laCompra.idunidad"
                                            ng-options="obj.id as obj.nombre for obj in unidades">
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-5">
                                    <div class="form-group required"
                                        ng-class="{'has-error':frmCompra.txtConceptoMayor.$invalid && !frmCompra.txtConceptoMayor.$pristine}">
                                        <label for="txtConceptoLibroMayor" class="control-label">Concepto para el libro
                                            mayor:</label>
                                        <textarea name="txtConceptoLibroMayor" id="txtConceptoLibroMayor"
                                            class="form-control" ng-model="laCompra.conceptomayor" rows="2"
                                            style="width:100%" required></textarea>
                                    </div>
                                </div>
                            </div>
                            <!--<div class="row"></div>-->
                            <div class="row">
                                <div class="col-md-2">
                                    <div class="form-group required"
                                        ng-class="{'has-error':frmCompra.txtTotal.$invalid && !frmCompra.txtTotal.$pristine}">
                                        <label for="txtTotal" class="control-label">Total:</label>
                                        <input name="txtTotal" id="txtTotal" type="text" class="form-control"
                                            ng-model="laCompra.totfact" placeholder="Total de factura"
                                            fcsa-number="{ min:0, maxDecimals: 2 }" ng-change="calcular()" required />
                                    </div>
                                </div>
                                <!-- IDP -->
                                <div class="col-md-2">
                                    <div class="form-group"
                                        ng-class="{'has-error':frmCompra.txtIDP.$invalid && !frmCompra.txtIDP.$pristine}">
                                        <label for="txtIDP">I.D.P.:</label>
                                        <input name="txtIDP" id="txtIDP" type="text" class="form-control"
                                            ng-model="laCompra.idp" placeholder="I.D.P."
                                            fcsa-number="{ min:0, maxDecimals: 2 }" required ng-disabled="true" />
                                    </div>
                                </div>
                                <!-- Fin de IDP -->
                                <div class="col-md-2">
                                    <div class="form-group"
                                        ng-class="{'has-error':frmCompra.txtNoAfecto.$invalid && !frmCompra.txtNoAfecto.$pristine}">
                                        <label for="txtNoAfecto">No afecto:</label>
                                        <input name="txtNoAfecto" id="txtNoAfecto" type="text" class="form-control"
                                            ng-model="laCompra.noafecto" placeholder="No afecto a impuesto"
                                            fcsa-number="{ min:0, maxDecimals: 2 }" ng-change="calcular()" required />
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group"
                                        ng-class="{'has-error':frmCompra.txtSubtot.$invalid && !frmCompra.txtSubtot.$pristine}">
                                        <label for="txtSubtot">Subtotal:</label>
                                        <input name="txtSubtot" id="txtSubtot" type="text" class="form-control"
                                            ng-model="laCompra.subtotal" placeholder="Subtotal"
                                            fcsa-number="{ min:0, maxDecimals: 2 }" required ng-disabled="true" />
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group"
                                        ng-class="{'has-error':frmCompra.txtIVA.$invalid && !frmCompra.txtIVA.$pristine}">
                                        <label for="txtIVA">I.V.A.:</label>
                                        <input name="txtIVA" id="txtIVA" type="text" class="form-control"
                                            ng-model="laCompra.iva" placeholder="I.V.A."
                                            fcsa-number="{ min:0, maxDecimals: 2 }" required ng-disabled="true" />
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group"
                                        ng-class="{'has-error':frmCompra.txtISR.$invalid && !frmCompra.txtISR.$pristine}">
                                        <label for="txtISR">I.S.R.:</label>
                                        <input name="txtISR" id="txtISR" type="text" class="form-control"
                                            ng-model="laCompra.isr" placeholder="I.S.R."
                                            fcsa-number="{ min:0, maxDecimals: 2 }" required ng-disabled="true" />
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-2">
                                    <div class="form-group"
                                        ng-class="{'has-error':frmCompra.chkCredFiscal.$invalid && !frmCompra.chkCredFiscal.$pristine}">
                                        <label for="chkCredFiscal">Cr&eacute;dito fiscal:</label>
                                        <input name="chkCredFiscal" id="chkCredFiscal" type="checkbox" class="checkbox"
                                            ng-model="laCompra.creditofiscal" ng-true-value="1" ng-false-value="0" />
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group"
                                        ng-class="{'has-error':frmCompra.chkExtraord.$invalid && !frmCompra.chkExtraord.$pristine}">
                                        <label for="chkExtraord">Extraordinario:</label>
                                        <input name="chkExtraord" id="chkExtraord" type="checkbox" class="checkbox"
                                            ng-model="laCompra.extraordinario" ng-true-value="1" ng-false-value="0" />
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group required"
                                        ng-class="{'has-error':frmCompra.txtFechaPago.$invalid && !frmCompra.txtFechaPago.$pristine}">
                                        <label for="txtFechaPago" class="control-label">Fecha de pago:</label>
                                        <input name="txtFechaPago" id="txtFechaPago" type="date" class="form-control"
                                            ng-model="laCompra.fechapago" required />
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group required"
                                        ng-class="{'has-error':frmCompra.selMoneda.$invalid && !frmCompra.selMoneda.$pristine}">
                                        <label for="selMoneda" class="control-label">Moneda:</label>
                                        <select name="selMoneda" id="selMoneda" class="form-control"
                                            ng-model="laCompra.objMoneda"
                                            ng-options="obj.nommoneda for obj in monedas track by obj.id"
                                            ng-change="setTipoCambio(laCompra.objMoneda)" required>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group required"
                                        ng-class="{'has-error':frmCompra.txtCambio.$invalid && !frmCompra.txtCambio.$pristine}">
                                        <label for="txtTCambioSug" class="control-label">Tipo de cambio:</label>
                                        <input name="txtTCambioSug" id="txtTCambioSug" class="form-control"
                                            ng-model="laCompra.tipocambio" type="text" min="1"
                                            fcsa-number="{ min:1, maxDecimals:dectc }" required />
                                    </div>
                                </div>
                            </div>
                            <div class="row" ng-show="yaPagada">
                                <div class="col-md-6 col-md-offset-3" style="background-color: #DCF8C6">
                                    <table class="table table-responsive table-condensed table-hover">
                                        <caption style="font-weight: bold; color: #0c0c0c">
                                            Factura pagada con las siguientes transacciones
                                        </caption>
                                        <thead>
                                            <tr>
                                                <th>Tipo</th>
                                                <th style="text-align: right">No.</th>
                                                <th>Banco</th>
                                                <th style="text-align: right">Monto</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr ng-repeat="t in tranpago">
                                                <td>{{t.tipodoc}}</td>
                                                <td style="text-align: right">{{t.numero}}</td>
                                                <td>{{t.banco}}</td>
                                                <td style="text-align: right">{{t.monto | number:2}}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="row" ng-show="laCompra.isr > 0">
                                <div class="col-md-6 col-md-offset-3"
                                    ng-show="laCompra.noformisr != null && laCompra.noformisr != undefined">
                                    <div class="well well-sm" style="text-align: center">
                                        <h4>Formulario de retenci&oacute;n de I.S.R.</h4>
                                        <h5>No. formulario: {{laCompra.noformisr}}&nbsp;--&nbsp;No. acceso:
                                            {{laCompra.noaccisr}}</h5>
                                        <h5>Fecha de pago:
                                            {{laCompra.fecpagoformisr | date:'dd/MM/yyyy'}}&nbsp;--&nbsp;Mes:
                                            {{laCompra.mesisr}}&nbsp;--&nbsp;A&ntilde;o: {{laCompra.anioisr}}</h5>
                                    </div>
                                </div>
                                <div class="col-md-6 col-md-offset-3"
                                    ng-hide="laCompra.noformisr != null && laCompra.noformisr != undefined">
                                    <div class="well well-sm" style="text-align: center">
                                        <span style="font-weight: bold">
                                            FORMULARIO DE RETENCI&Oacute;N DE I.S.R. NO REGISTRADO.&nbsp;
                                            <button type="button" class="btn" ng-click="modalISR()">Registrar</button>
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="btn-group" role="group" aria-label="...">
                                <button type="submit" class="btn btn-primary"
                                    ng-disabled="frmCompra.$invalid || periodoCerrado" ng-hide="editando">
                                    <span class="glyphicon glyphicon-floppy-save"></span>
                                </button>
                                <button type="button" class="btn btn-primary"
                                    ng-disabled="frmCompra.$invalid || periodoCerrado" ng-show="editando"
                                    ng-click="updCompra(laCompra)">
                                    <span class="glyphicon glyphicon-floppy-save"></span>
                                </button>
                                <!--
                                <button type="button" class="btn btn-primary" ng-show="editando" ng-click="printVersion(laCompra)">
                                    <span class="glyphicon glyphicon-print"></span>
                                </button>
                                -->
                                <button type="button" class="btn btn-danger" ng-disabled="yaPagada || periodoCerrado"
                                    ng-show="editando" ng-click="delCompra(laCompra)">
                                    <span class="glyphicon glyphicon-trash"></span>
                                </button>
                                <button type="button" class="btn btn-primary" ng-disabled="frmCompra.$invalid"
                                    ng-show="editando" ng-click="resetCompra()">
                                    <span class="glyphicon glyphicon-plus"></span>
                                </button>
                                <button type="button" class="btn btn-primary" ng-show="+laCompra.id > 0"
                                    ng-click="bindCheque()">
                                    <span class="glyphicon glyphicon-list"></span>
                                </button>
                                <a href="/sayet/php/compra.php/comprobante/{{laCompra.id}}" target="_blank"
                                    class="btn btn-default">
                                    <span class="glyphicon glyphicon-print"></span> Comprobante
                                </a>
                            </div>
                        </form>
                        <hr/>
                    </div>
                    <div id="divReembolso" class="row" ng-show="+presupuesto.tipodocumento == 2"></div>
                </div>
            </div>
        </div>
    </div>
</div>
<script type="text/ng-template" id="modalSelectCtaGastoProv.html">
    <div class="modal-header">
        <h3 class="modal-title">Selecci&oacute;n de cuenta de gasto de proveedor</h3>
    </div>
    <div class="modal-body">
        <label for="selCtaGasto">¿Qu&eacute; cuenta de gasto de este proveedor desea usar para el detalle contable?</label>
        <select name="selCtaGasto" id="selCtaGasto" class="form-control" ng-model="selectedCta"
                ng-options="obj.cuentac for obj in lasCtasGasto" multiple required>
        </select>
    </div>
    <div class="modal-footer">
        <button class="btn btn-primary" type="button" ng-click="ok()">Aceptar</button>
        <button class="btn btn-warning" type="button" ng-click="cancel()">Cancelar</button>
    </div>
</script>
<script type="text/ng-template" id="modalISR.html">
    <div class="modal-header">
        <h3 class="modal-title">Formulario de retenci&oacute;n I.S.R.</h3>
        <h4 class="modal-title">{{compra.nomproveedor}}</h4>
        <h4 class="modal-title">Factura {{compra.serie}}&nbsp;{{compra.documento}}&nbsp;por&nbsp;{{compra.moneda}}&nbsp;{{compra.totfact | number:2}}</h4>
    </div>
    <div class="modal-body">
        <div class="form-group">
            <label for="txtNoFormISR">No. de formulario:</label>
            <input name="txtNoFormISR" id="txtNoFormISR" type="text" class="form-control" ng-model="compra.noformisr" maxlength="30"/>
        </div>
        <div class="form-group">
            <label for="txtNoAccISR">No. de acceso:</label>
            <input name="txtNoAccISR" id="txtNoAccISR" type="text" class="form-control" ng-model="compra.noaccisr" maxlength="30"/>
        </div>
        <div class="form-group">
            <label for="txtFecPagoISR">Fecha de pago:</label>
            <input name="txtFecPagoISR" id="txtFecPagoISR" type="date" class="form-control" ng-model="compra.fecpagoformisr" ng-change="setMesAnio()"/>
        </div>
        <div class="form-group">
            <label for="txtMesISR">Mes:</label>
            <input name="txtMesISR" id="txtMesISR" type="number" class="form-control" ng-model="compra.mesisr" min="0" max="12"/>
        </div>
        <div class="form-group">
            <label for="txtAnioISR">A&ntilde;o:</label>
            <input name="txtAnioISR" id="txtAnioISR" type="number" class="form-control" ng-model="compra.anioisr" min="2000" max="3000"/>
        </div>
    </div>
    <div class="modal-footer">
        <button class="btn btn-primary" type="button" ng-click="ok()">Aceptar</button>
        <button class="btn btn-warning" type="button" ng-click="cancel()">Cancelar</button>
    </div>
</script>